<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dynamic Iframe Loader</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f8f8;
      padding: 20px;
      text-align: center;
    }

    iframe {
      width: 100%;
      height: 80vh;
      border: none;
      display: none;
    }

    /* Loading animation */
    .loader {
      margin: 40px auto;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #3498db;
      animation: pulse 1s infinite ease-in-out;
    }

    @keyframes pulse {
      0% { transform: scale(0.8); opacity: 0.6; }
      50% { transform: scale(1); opacity: 1; }
      100% { transform: scale(0.8); opacity: 0.6; }
    }

    /* Adblock message */
    #adblock-warning {
      display: none;
      padding: 20px;
      border-radius: 10px;
      background: #ff4444;
      color: white;
      font-size: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h2 id="status">Loading content…</h2>

<div id="loader" class="loader"></div>

<div id="adblock-warning">
  ⚠️ AdBlock detected!<br>
  Please disable your AdBlocker and refresh the page.
</div>

<iframe id="viewer"></iframe>

<script>
// ============================================================
// ULTRA ACCURATE ADBLOCK DETECTOR (NO FALSE POSITIVES)
// Uses 3 detection layers:
// 1. CSS bait block
// 2. Script filter block (Google Ads)
// 3. Real ad request block (DoubleClick GPT)
// ============================================================

async function accurateAdblockDetector() {
  // Test 1: CSS bait
  let bait = document.createElement("div");
  bait.className = "adsbox ad-banner ad-unit advertisement";
  bait.style.position = "absolute";
  bait.style.top = "-1000px";
  bait.style.height = "1px";
  document.body.appendChild(bait);

  let cssBlocked = false;
  await new Promise(r => setTimeout(r, 200));

  if (
    bait.offsetHeight === 0 ||
    getComputedStyle(bait).display === "none" ||
    bait.offsetParent === null
  ) {
    cssBlocked = true;
  }

  bait.remove();


  // Test 2: Script-block check (real Google Ads JS)
  let scriptBlocked = false;
  try {
    await fetch("https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js", {
      method: "HEAD",
      mode: "no-cors"
    });
  } catch (e) {
    scriptBlocked = true;
  }


  // Test 3: Real ad request block (DoubleClick GPT)
  let networkBlocked = false;
  try {
    await fetch("https://securepubads.g.doubleclick.net/tag/js/gpt.js", {
      method: "HEAD",
      mode: "no-cors"
    });
  } catch (e) {
    networkBlocked = true;
  }

  // Only TRUE if all 3 systems fail
  return (cssBlocked && scriptBlocked && networkBlocked);
}

// ============================================================
// Start detection before loading anything
// ============================================================

accurateAdblockDetector().then(isBlocked => {

  if (isBlocked) {
    document.getElementById("loader").style.display = "none";
    document.getElementById("status").innerText = "AdBlock Detected!";
    document.getElementById("adblock-warning").style.display = "block";
    return; // STOP PAGE LOADING
  }

  startLoadingProcess();
});


// ============================================================
// Main loader function
// ============================================================

function startLoadingProcess() {
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");

  if (!id) {
    document.getElementById("status").innerText = "Error: No ID provided in URL.";
    return;
  }

  loadURLFromText(id);
}


// ============================================================
// Load URL from links.txt
// Format inside links.txt:
// abc123=https://example.com/video
// ============================================================

function loadURLFromText(id) {
  fetch("functions/api/get?id=" + id)
    .then(r => r.text())
    .then(foundURL => {
      if (foundURL === "Not found") {
        document.getElementById("status").innerText = "No URL found.";
        document.getElementById("loader").style.display = "none";
        return;
      }

      const iframe = document.getElementById("viewer");
      iframe.onload = () => {
        document.getElementById("loader").style.display = "none";
        iframe.style.display = "block";
        document.getElementById("status").innerText = "Loaded:";
      };
      iframe.src = foundURL.trim();
    })
    .catch(err => {
      document.getElementById("status").innerText = "Error: " + err;
      document.getElementById("loader").style.display = "none";
    });
}

</script>

</body>
</html>
