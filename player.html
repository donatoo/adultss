<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Custom Video Player</title>
  <style>
    body { margin: 0; background: #000; color: #fff; font-family: Arial, sans-serif; }
    #video-container { position: relative; width: 100%; height: 100vh; background: #000; }
    video { width: 100%; height: 100%; }
    #center-controls { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 20px; opacity: 0; transition: opacity 0.3s; }
    #video-container:hover #center-controls { opacity: 1; }
    #center-play, #center-rewind, #center-forward { font-size: 48px; background: rgba(0,0,0,0.5); border: none; color: #fff; padding: 10px; cursor: pointer; border-radius: 50%; }
    #controls { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); padding: 10px; display: flex; align-items: center; gap: 10px; }
    button { background: #333; color: #fff; border: none; padding: 5px 10px; cursor: pointer; }
    button:hover { background: #555; }
    #progress { flex: 1; height: 5px; background: #333; cursor: pointer; }
    #progress-bar { height: 100%; background: #f00; width: 0%; }
    #volume-container { display: flex; align-items: center; gap: 5px; }
    #volume { width: 100px; }
    #speaker { font-size: 18px; cursor: pointer; }
    #subtitle-display { position: absolute; bottom: 80px; left: 10px; right: 10px; text-align: center; font-size: 20px; color: #fff; text-shadow: 2px 2px 2px #000; pointer-events: none; }
    #settings-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #222; padding: 20px; border-radius: 10px; z-index: 1000; }
    #settings-modal label { display: block; margin: 10px 0; }
    #settings-modal input, #settings-modal select { width: 100%; }
  </style>
</head>
<body>
  <div id="video-container">
    <video id="video"></video>
    <div id="subtitle-display"></div>
    <div id="center-controls">
      <button id="center-rewind" title="Rewind 10 seconds">&#9664;&#9664; 10s</button>
      <button id="center-play" title="Play/Pause">&#9658;</button>
      <button id="center-forward" title="Forward 10 seconds">10s &#9654;&#9654;</button>
    </div>
    <div id="controls">
      <input type="range" id="volume" min="0" max="1" step="0.1" value="1">
      <button id="speaker" title="Mute/Unmute">&#128266;</button>
      <button id="fullscreen">Fullscreen</button>
      <button id="download">Download</button>
      <select id="subtitle-picker"></select>
      <select id="quality-picker"></select>
      <button id="settings">Settings</button>
    </div>
    <div id="progress" onclick="seek(event)">
      <div id="progress-bar"></div>
    </div>
  </div>
  <div id="settings-modal">
    <h3>Subtitle Settings</h3>
    <label>Font Size: <input type="number" id="font-size" value="20"></label>
    <label>Text Color: <input type="color" id="text-color" value="#ffffff"></label>
    <label>Background Color: <input type="color" id="bg-color" value="#000000"></label>
    <label>Background Opacity: <input type="number" step="0.1" id="bg-opacity" value="0.5"></label>
    <label>Position: <select id="position"><option value="bottom">Bottom</option><option value="top">Top</option></select></label>
    <label>Vertical Position: <input type="range" id="v-pos" min="0" max="100" value="90"></label>
    <button onclick="applySettings()">Apply</button>
    <button onclick="closeSettings()">Close</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const video = document.getElementById('video');
    const controls = document.getElementById('controls');
    const subtitleDisplay = document.getElementById('subtitle-display');
    const progressBar = document.getElementById('progress-bar');
    const settingsModal = document.getElementById('settings-modal');
    let hls;
    let subtitles = [];
    let currentSub = null;

    // Parse URL
    const urlParams = new URLSearchParams(window.location.search);
    let videoUrl = urlParams.get('mp4') || urlParams.get('m3u');
    let isM3U = urlParams.has('m3u');

    if (videoUrl) {
      if (isM3U) {
        if (Hls.isSupported()) {
          hls = new Hls();
          hls.loadSource(videoUrl);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
            // Populate quality picker
            const qualitySelect = document.getElementById('quality-picker');
            qualitySelect.innerHTML = '<option value="-1">Auto</option>';
            data.levels.forEach((level, index) => {
              const option = document.createElement('option');
              option.value = index;
              option.textContent = level.height + 'p';
              qualitySelect.appendChild(option);
            });
            qualitySelect.addEventListener('change', (e) => {
              hls.currentLevel = e.target.value;
            });
          });
        }
      } else {
        video.src = videoUrl;
      }
    }

    // Controls
    const playBtn = document.getElementById('center-play');
    const speakerBtn = document.getElementById('speaker');

    function togglePlay() {
      if (video.paused) {
        video.play();
        playBtn.innerHTML = '&#10074;&#10074;'; // Pause icon
      } else {
        video.pause();
        playBtn.innerHTML = '&#9658;'; // Play icon
      }
    }

    playBtn.addEventListener('click', togglePlay);

    document.getElementById('center-rewind').addEventListener('click', () => {
      video.currentTime -= 10;
    });

    document.getElementById('center-forward').addEventListener('click', () => {
      video.currentTime += 10;
    });

    document.getElementById('volume').addEventListener('input', (e) => {
      video.volume = e.target.value;
      video.muted = false;
      updateSpeakerIcon();
    });

    speakerBtn.addEventListener('click', () => {
      video.muted = !video.muted;
      updateSpeakerIcon();
    });

    function updateSpeakerIcon() {
      if (video.muted || video.volume === 0) {
        speakerBtn.innerHTML = '&#128263;'; // Muted icon
      } else {
        speakerBtn.innerHTML = '&#128266;'; // Speaker icon
      }
    }

    document.getElementById('fullscreen').addEventListener('click', () => {
      if (video.requestFullscreen) {
        video.requestFullscreen();
      }
    });

    document.getElementById('download').addEventListener('click', async () => {
      if (!isM3U) {
        const a = document.createElement('a');
        a.href = videoUrl;
        a.download = 'video.mp4';
        a.click();
      } else {
        // For M3U, download segments and combine (simplified, may not work for all)
        alert('Downloading playlists is complex; not implemented yet.');
      }
    });

    // Subtitle picker (placeholder)
    document.getElementById('subtitle-picker').addEventListener('change', (e) => {
      // Load subtitle from URL
      loadSubtitles(e.target.value);
    });

    function loadSubtitles(url) {
      fetch(url)
        .then(res => res.text())
        .then(text => {
          // Parse VTT or SRT
          // Simplified parsing
          const cues = parseVTT(text);
          subtitles = cues;
        });
    }

    function parseVTT(vtt) {
      // Basic VTT parser
      const lines = vtt.split('\n');
      const cues = [];
      let i = 0;
      while (i < lines.length) {
        if (lines[i].includes('-->')) {
          const time = lines[i].split(' --> ');
          const start = parseTime(time[0]);
          const end = parseTime(time[1]);
          let text = '';
          i++;
          while (i < lines.length && lines[i].trim()) {
            text += lines[i] + '\n';
            i++;
          }
          cues.push({ start, end, text: text.trim() });
        } else {
          i++;
        }
      }
      return cues;
    }

    function parseTime(timeStr) {
      const parts = timeStr.split(':');
      const seconds = parts[2].split('.')[0];
      return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(seconds);
    }

    video.addEventListener('timeupdate', () => {
      const progress = (video.currentTime / video.duration) * 100;
      progressBar.style.width = progress + '%';
      // Show subtitle
      const currentCue = subtitles.find(cue => video.currentTime >= cue.start && video.currentTime <= cue.end);
      subtitleDisplay.textContent = currentCue ? currentCue.text : '';
    });

    function seek(event) {
      const rect = document.getElementById('progress').getBoundingClientRect();
      const pos = (event.clientX - rect.left) / rect.width;
      video.currentTime = pos * video.duration;
    }

    // Settings
    document.getElementById('settings').addEventListener('click', () => {
      settingsModal.style.display = 'block';
    });

    function applySettings() {
      const fontSize = document.getElementById('font-size').value;
      const textColor = document.getElementById('text-color').value;
      const bgColor = document.getElementById('bg-color').value;
      const bgOpacity = document.getElementById('bg-opacity').value;
      const position = document.getElementById('position').value;
      const vPos = document.getElementById('v-pos').value;

      subtitleDisplay.style.fontSize = fontSize + 'px';
      subtitleDisplay.style.color = textColor;
      subtitleDisplay.style.background = `rgba(${hexToRgb(bgColor)}, ${bgOpacity})`;
      subtitleDisplay.style[position] = vPos + '%';
      if (position === 'top') {
        subtitleDisplay.style.bottom = 'auto';
        subtitleDisplay.style.top = vPos + '%';
      } else {
        subtitleDisplay.style.top = 'auto';
        subtitleDisplay.style.bottom = vPos + '%';
      }
      settingsModal.style.display = 'none';
    }

    function closeSettings() {
      settingsModal.style.display = 'none';
    }

    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : null;
    }
  </script>
</body>
</html>
